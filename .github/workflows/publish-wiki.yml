name: Publish Wiki

on:
  workflow_dispatch:
    # Allow manual triggering
  schedule:
    # Run daily at 2:00 AM GMT
    - cron: '0 2 * * *'

jobs:
  publish-wiki:
    name: Clone and Publish Wiki
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Clone wiki repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“š Cloning wiki repository..."
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.wiki.git wiki-repo || {
            echo "âš ï¸ Wiki repository not found or not initialized"
            echo "To initialize the wiki, visit: https://github.com/${{ github.repository }}/wiki"
            exit 1
          }

      - name: List wiki pages
        run: |
          echo "ðŸ“‹ Wiki pages found:"
          cd wiki-repo
          find . -name "*.md" -type f | sort
          echo ""
          echo "ðŸ“Š Total pages: $(find . -name "*.md" -type f | wc -l)"

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic
          
          # Install Node.js for Mermaid CLI
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Install mermaid-cli for diagram conversion
          sudo npm install -g @mermaid-js/mermaid-cli
          
          # Install Playwright for mermaid-cli (required for rendering)
          sudo npx playwright install --with-deps chromium

      - name: Convert wiki to PDF
        run: |
          cd wiki-repo
          echo "ðŸ”„ Preparing wiki for PDF conversion..."
          
          # Create output directory
          mkdir -p pdf-output
          mkdir -p images
          
          # Process Mermaid diagrams
          echo "ðŸŽ¨ Converting Mermaid diagrams to images..."
          counter=1
          find . -name "*.md" -type f | while read file; do
            # Extract and convert mermaid diagrams
            awk '/```mermaid/,/```/' "$file" | grep -v '```' > /tmp/mermaid_block.txt || true
            if [ -s /tmp/mermaid_block.txt ]; then
              echo "Found Mermaid diagram in $file"
              mmdc -i /tmp/mermaid_block.txt -o "images/mermaid-${counter}.png" -b transparent 2>&1 || echo "Failed to convert diagram in $file"
              counter=$((counter + 1))
            fi
          done
          
          # Replace mermaid blocks with image references in markdown files
          echo "ðŸ”„ Replacing Mermaid blocks with images..."
          counter=1
          find . -name "*.md" -type f | while read file; do
            if grep -q '```mermaid' "$file"; then
              # Create a temporary file with mermaid blocks replaced
              awk -v counter=$counter '
                /```mermaid/ { 
                  in_mermaid=1; 
                  print "![Mermaid Diagram](images/mermaid-" counter ".png)";
                  counter++;
                  next;
                }
                /```/ && in_mermaid { 
                  in_mermaid=0; 
                  next;
                }
                !in_mermaid { print }
              ' "$file" > "${file}.tmp"
              mv "${file}.tmp" "$file"
              counter=$((counter + 1))
            fi
          done
          
          echo "ðŸ“š Creating combined PDF..."
          
          # Combine all markdown files into one
          echo "# Wiki Documentation" > combined.md
          echo "" >> combined.md
          echo "**Generated:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> combined.md
          echo "" >> combined.md
          echo "**Repository:** ${{ github.repository }}" >> combined.md
          echo "" >> combined.md
          echo "---" >> combined.md
          echo "" >> combined.md
          
          # Append all markdown files
          find . -name "*.md" -type f ! -name "combined.md" | sort | while read file; do
            filename=$(basename "$file" .md)
            echo "" >> combined.md
            echo "\\newpage" >> combined.md
            echo "" >> combined.md
            echo "# ${filename}" >> combined.md
            echo "" >> combined.md
            cat "$file" >> combined.md
            echo "" >> combined.md
          done
          
          # Convert combined markdown to PDF with image support
          echo "ðŸ“„ Converting to PDF..."
          pandoc combined.md \
            -o "pdf-output/wiki-complete.pdf" \
            --pdf-engine=xelatex \
            -V geometry:margin=1in \
            -V colorlinks=true \
            -V linkcolor=blue \
            -V urlcolor=blue \
            --toc \
            --resource-path=.:images \
            --metadata title="Wiki Documentation" \
            --metadata author="${{ github.repository }}" \
            --metadata date="$(date +'%Y-%m-%d')" \
            2>&1 || echo "âš ï¸ Failed to create combined PDF"
          
          echo ""
          echo "âœ… PDF conversion complete"
          ls -lh pdf-output/wiki-complete.pdf

      - name: Create wiki archive
        run: |
          cd wiki-repo
          echo "ðŸ“¦ Creating archive summary..."
          
          # Create a summary file in PDF output
          cat > pdf-output/README.md << EOF
          # Wiki Documentation Archive
          
          **Generated:** $(date +'%Y-%m-%d %H:%M:%S UTC')
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          
          ## Contents
          
          - \`wiki-complete.pdf\` - Complete wiki documentation with table of contents
          
          ## Source Pages
          
          EOF
          
          # List all source markdown files
          find . -name "*.md" -type f ! -name "combined.md" | sort | while read file; do
            echo "- \`${file#./}\`" >> pdf-output/README.md
          done
          
          echo "" >> pdf-output/README.md
          echo "---" >> pdf-output/README.md
          echo "" >> pdf-output/README.md
          echo "Total source pages: $(find . -name "*.md" -type f ! -name "combined.md" | wc -l)" >> pdf-output/README.md

      - name: Upload wiki PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: wiki-documentation-${{ github.run_number }}
          path: wiki-repo/pdf-output/wiki-complete.pdf
          retention-days: 90
          if-no-files-found: error

      - name: Create GitHub Step Summary
        run: |
          cd wiki-repo
          echo "# ðŸ“š Wiki Documentation Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully converted wiki to PDF" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Pages:** $(find . -name "*.md" -type f ! -name "combined.md" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **PDF File:** \`wiki-complete.pdf\`" >> $GITHUB_STEP_SUMMARY
          echo "- **File Size:** $(ls -lh pdf-output/wiki-complete.pdf | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** \`wiki-documentation-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention:** 90 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“„ Document Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Table of contents" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All wiki pages in one document" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Clickable hyperlinks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Professional formatting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip:** Download the artifact to access the complete wiki documentation as a single PDF file." >> $GITHUB_STEP_SUMMARY
