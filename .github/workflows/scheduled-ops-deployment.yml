name: Scheduled Full Deployment

on:
  schedule:
    # Runs at 9:22 PM GMT daily
    - cron: '22 21 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

jobs:
  check-enabled:
    name: Check if scheduled deployment is enabled
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Check environment variable
        id: check
        run: |
          # Check if scheduled deployment is enabled
          if [[ "${{ vars.ENABLE_SCHEDULED_DEPLOYMENT }}" == "true" ]]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "✅ Scheduled deployment is enabled"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "⏭️ Scheduled deployment is disabled via ENABLE_SCHEDULED_DEPLOYMENT variable"
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Enabled:** ${{ vars.ENABLE_SCHEDULED_DEPLOYMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Schedule:** \`22 21 * * *\` (9:22 PM GMT daily)" >> $GITHUB_STEP_SUMMARY

  start-lab:
    name: 1. Start Lab
    needs: check-enabled
    if: needs.check-enabled.outputs.enabled == 'true'
    uses: ./.github/workflows/start-lab.yml
    secrets: inherit

  terraform-deploy:
    name: 2. Deploy Terraform Infrastructure
    needs: start-lab
    uses: ./.github/workflows/terraform-deploy.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    with:
      action: apply

  deploy-services:
    name: 3. Build and Deploy Microservices
    needs: terraform-deploy
    uses: ./.github/workflows/deploy-services.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read
    with:
      service: all

  deploy-services-retry-1:
    name: 3. Build and Deploy Microservices (Retry 1)
    needs: [terraform-deploy, deploy-services]
    if: failure() && needs.deploy-services.result == 'failure'
    uses: ./.github/workflows/deploy-services.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read
    with:
      service: all

  deploy-services-retry-2:
    name: 3. Build and Deploy Microservices (Retry 2)
    needs: [terraform-deploy, deploy-services, deploy-services-retry-1]
    if: failure() && needs.deploy-services-retry-1.result == 'failure'
    uses: ./.github/workflows/deploy-services.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read
    with:
      service: all

  deployment-summary:
    name: Deployment Summary
    needs: [check-enabled, start-lab, terraform-deploy, deploy-services, deploy-services-retry-1, deploy-services-retry-2]
    runs-on: ubuntu-latest
    if: always() && needs.check-enabled.outputs.enabled == 'true'
    steps:
      - name: Generate summary
        run: |
          echo "# Scheduled Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Start Lab: ${{ needs.start-lab.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform Deploy: ${{ needs.terraform-deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy Services: ${{ needs.deploy-services.result }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.deploy-services-retry-1.result }}" != "skipped" ]]; then
            echo "- Deploy Services (Retry 1): ${{ needs.deploy-services-retry-1.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.deploy-services-retry-2.result }}" != "skipped" ]]; then
            echo "- Deploy Services (Retry 2): ${{ needs.deploy-services-retry-2.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- Deploy Services: ${{ needs.deploy-services.result }}" >> $GITHUB_STEP_SUMMARY
