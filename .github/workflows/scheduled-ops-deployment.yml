name: Scheduled Full Deployment

on:
  schedule:
    # Runs based on DEPLOYMENT_CRON_SCHEDULE variable (default: 1:30 AM GMT daily)
    # Example values: '30 1 * * *' (daily), '0 */6 * * *' (every 6 hours), '0 9 * * 1' (Mondays at 9 AM)
    - cron: '30 1 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

jobs:
  check-enabled:
    name: Check if scheduled deployment is enabled
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
      cron_schedule: ${{ steps.check.outputs.cron_schedule }}
    steps:
      - name: Check environment variable
        id: check
        run: |
          # Check if scheduled deployment is enabled
          if [[ "${{ vars.ENABLE_SCHEDULED_DEPLOYMENT }}" == "true" ]]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "âœ… Scheduled deployment is enabled"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Scheduled deployment is disabled via ENABLE_SCHEDULED_DEPLOYMENT variable"
          fi
          
          # Get cron schedule (for informational purposes)
          CRON_SCHEDULE="${{ vars.DEPLOYMENT_CRON_SCHEDULE }}"
          if [[ -z "$CRON_SCHEDULE" ]]; then
            CRON_SCHEDULE="30 1 * * *"
          fi
          echo "cron_schedule=$CRON_SCHEDULE" >> $GITHUB_OUTPUT
          echo "ðŸ“… Cron schedule: $CRON_SCHEDULE"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Enabled:** ${{ vars.ENABLE_SCHEDULED_DEPLOYMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Schedule:** \`$CRON_SCHEDULE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** The cron schedule is set in the workflow file. To change it, update the \`schedule.cron\` value in \`.github/workflows/scheduled-ops-deployment.yml\` or use the DEPLOYMENT_CRON_SCHEDULE variable for reference." >> $GITHUB_STEP_SUMMARY

  start-lab:
    name: 1. Start Lab
    needs: check-enabled
    if: needs.check-enabled.outputs.enabled == 'true'
    uses: ./.github/workflows/start-lab.yml
    secrets: inherit

  terraform-deploy:
    name: 2. Deploy Terraform Infrastructure
    needs: start-lab
    uses: ./.github/workflows/terraform-deploy.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    with:
      action: apply

  deploy-services:
    name: 3. Build and Deploy Microservices
    needs: terraform-deploy
    uses: ./.github/workflows/deploy-services.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read
    with:
      service: all

  deployment-summary:
    name: Deployment Summary
    needs: [check-enabled, start-lab, terraform-deploy, deploy-services]
    runs-on: ubuntu-latest
    if: always() && needs.check-enabled.outputs.enabled == 'true'
    steps:
      - name: Generate summary
        run: |
          echo "# Scheduled Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Start Lab: ${{ needs.start-lab.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform Deploy: ${{ needs.terraform-deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy Services: ${{ needs.deploy-services.result }}" >> $GITHUB_STEP_SUMMARY
